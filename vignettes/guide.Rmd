---
title: "Guide for package DesignCTPB"
author: "Yitao Lu, Belaid, Xuekui Zhang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DesignCTPB}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
#Introduction
As a future trend of health care, personalized medicine tailors medical treatments to individual patients. It requires to identify a subset of patients with the best response to treatment. The subset can be defined by a biomarker (e.g. expression of a gene) and its cutoff value. However, designing clinical trials that utilize the discovered uncertain subsets/biomarkers is not trivial and rarely discussed in the literature. 

And we formulate the problem of clinical trial design into an optimization problem involving high-dimensional integration, and propose a novel computational solution based on Monte-Carlo and smoothing methods.  Our method utilizes the modern techniques of General-Purpose computing on Graphics Processing Units for large-scale parallel computing. Compared to a published method in three-dimensional problems, our approach is more accurate and 133 times faster. This advantage increases when dimensionality increases.  Our method is scalable to higher-dimensional problems since the precision bound of our estimated study power is a finite number not affected by dimensionality.

This package can guide researchers to do clinical trials with nested sub-population effect, which is easily to use. Before using the package, please check your CUDA and CUDAtoolkit are well-installed. Here are the guidance for users.



```{r library, echo = T, results = 'hide', warning=FALSE, message=FALSE}
library(DesignCTPB)
library(webshot)
```

## set up the python environment and check the required modules 
```{r set up environment, eval=FALSE, message=FALSE, warning=FALSE}
create_venv("numba2r") #can specify any python path 
```
```{r python initiate}
py_initial("numba2r")
```

## Calculating optimal alpha-split for a given setting of proportion of each subpopulation
```{r alpha_split, message=FALSE, warning=FALSE}
alpha_split()# the default setting will give an optimal results of 3-dimensional case
```


## Calculating optimal alpha-split for many settings of r values (i.e. size of nested subpopulations), and visualize their results and calculate optimal choice of r values

First, we show the results presented in our paper, which shows the strong and weak biomarker effect examples. Below shows how to get the results. m is the density value for grid setting or r(the proportion for each sub-population); n_dim denotes the dimension; N1 and N2 are fixed and we suggest do not change them otherwise have to change the corresponding the number of threads and block in python code. N3 could be changed and has to be the multiplier of 5. E is the total number of events in the clinical trial, if not specified, we will apply an estimated information units, please refer to formula(10) in our paper. SIGMA is the matrix of standard deviation of each sub-population, which should coincide with r_set or the default setting of each sub-population(i.e each entry of each row coincides to the corresponding entry in r_set). For simplify, we apply $\sigma_i = \frac{1}{\sqrt{20*r_i}}$ which has been explained in the paper. DELTA is the matrix of harzard reduction conrresponding to the r setting too. While for simplify, we use a linear scheme of harzard reduction, which means $\Delta_i = 0.8-0.6*r_i$ in our example below. 
```{r visulization, eval=FALSE, warning=FALSE, tidy=TRUE}
res <- design_ctpb(m=24, n_dim=3, N1=20480, N2=10240, N3=2000, E=NULL, SIGMA=NULL, sd_full=1/base::sqrt(20), DELTA=NULL, delta_linear_bd=c(0.2,0.8), seed=NULL)
res$plot_alpha # to see the 3-d rotatable plot of optimal alpha versus r2 and r3.
res$plot_power # to see the 3-d rotatable plot of optimal power versus r2 and r3.
res$opt_r_split
res$opt_alpha_split
res$opt_power
```

For the time consuming problem, we load the pre-run data and show the results below.

### Strong biomarker effect
```{r load data strong}
data("res_strong")
```


```{r echo=TRUE, warning=FALSE}
res_strong$plot_power
```

```{r echo=TRUE, warning=FALSE}
res_strong$plot_alpha
```

```{r warning=FALSE}
res_strong$opt_r_split
res_strong$opt_power
res_strong$opt_alpha_split
```

### Weak biomarker effect
```{r load data week}
data("res_weak")
```


```{r eval=FALSE, warning=FALSE}
res_weak$plot_power
```

```{r eval=FALSE, warning=FALSE}
res_weak$plot_alpha
```

```{r warning=FALSE}
res_weak$opt_r_split
res_weak$opt_power
res_weak$opt_alpha_split
```

For the weak biomarker effect, we find that $r_3 = 0$, which suggests only consider one subpopulation instead of two, reducing the optimization into two dimension. Then we have to compute the optimal alpha split in two dimension.
```{r warning=FALSE}
alpha_split(r=c(1,0.303),N3=100,sd_full=1/base::sqrt(20),delta_linear_bd = c(0.2,0.3))
```

For another way, we could re-design the clinical trial in two dimension.

```{r eval=FALSE, warning=FALSE}
r2 <- seq(0.025,1,by=0.025)
res <- matrix(rep(0,3*length(r2)), ncol=3)
for(ii in 1:length(r2)){
  res[ii,] <- alpha_split(r=c(1,r2[ii]),N3=100,sd_full=sqrt(20),delta_linear_bd = c(0.2,0.3))
}
```
One can use smooth model to fit and find the maximization, but we could also just take the maximizer right away.
```{r eval=FALSE, warning=FALSE}
power_value <- res[,3]
opt_r2 <- r2[which.max(power_value)]
opt_alpha <- res[which.max(power_value),1:2]
opt_r2
opt_alpha
```


